<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Range Trainer vT1</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1520; --panel2:#101827; --border:#223047; --text:#e7ecf3;
    --push:#6d4b8e; --mr:#c24a4a; --limp:#7fcf7f;
    --ok:#1f9d55; --err:#d64545;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;z-index:30;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;background:#101827;border-bottom:1px solid var(--border)}
  .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#0f1624;font-size:12px}
  .btn{border:1px solid var(--border);background:#0f1624;color:var(--text);border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.big{padding:14px 18px;font-size:18px}
  .btn.alt{background:#132035}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}

  /* Card areas */
  .grid{display:grid;gap:12px}
  @media (min-width:980px){.grid{grid-template-columns:1.1fr 0.9fr}}
  .card{border:1px solid var(--border);background:#0f1624;border-radius:14px;padding:12px}
  .card h3{margin:0 0 10px;font-size:16px}

  /* Quiz area */
  .qTop{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .qHand{font-size:28px;font-weight:900;letter-spacing:.5px}
  .qStack,.qPos{font-weight:800;opacity:.9}
  .ansRow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text);font-weight:800}
  .actionKeys{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .actionKeys .btn{padding:12px 8px;font-size:14px}
  .feedback{margin-top:10px;font-weight:900}
  .ok{color:var(--ok)} .err{color:var(--err)}

  /* Controls */
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#0f1624;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer}
  .badge input{accent-color:#4da3ff}
  .sep{height:1px;background:#223047;margin:10px 0}

  /* Editor modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:60;align-items:center;justify-content:center;padding:16px}
  .overlay.show{display:flex}
  .box{width:100%;max-width:680px;background:#0f1520;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .boxHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#101827;border-bottom:1px solid var(--border)}
  .boxBody{padding:10px 12px}
  .boxFoot{display:flex;gap:8px;justify-content:space-between;padding:10px 12px;border-top:1px solid var(--border);background:#0f1520}
  textarea{width:100%;min-height:260px;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;font:14px/1.35 ui-monospace,Menlo,Consolas}
  .mini{font-size:12px;opacity:.8}

  .resRow{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px 10px;border:1px dashed #2a3b58;border-radius:10px;margin-top:8px}
  .val{font-weight:900;padding:6px 8px;border-radius:8px;min-width:96px;text-align:center}
</style>
</head>
<body>
  <div class="top">
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <span class="chip">Въпроси: <b id="qCount">0</b></span>
      <span class="chip">Вярно: <b id="qRight">0</b></span>
      <span class="chip">Серия: <b id="streak">0</b></span>
      <span class="chip">Време: <b id="timer">00:00</b></span>
    </div>
    <div style="display:flex;gap:6px">
      <button class="btn" id="btnEdit">Редактор</button>
      <button class="btn alt" id="btnData">Import/Export</button>
    </div>
  </div>

  <div class="wrap grid">
    <!-- QUIZ -->
    <div class="card">
      <h3>Тест</h3>
      <div class="qTop">
        <div class="qHand" id="qHand">—</div>
        <div class="qStack" id="qStack">Стак: —</div>
        <div class="qPos" id="qPos">Позиция: —</div>
      </div>

      <div class="ansRow">
        <input id="answer" class="input" placeholder="Напиши действие (напр. L-C-AI, MR-F-F, Shove, 37)" inputmode="latin" autocomplete="off" autocapitalize="characters">
        <button id="btnCheck" class="btn big">Провери</button>
      </div>

      <div class="actionKeys" id="quickKeys"></div>

      <div id="feedback" class="feedback"></div>
      <div id="correctRow" class="resRow" style="display:none">
        <div>Правилен отговор:</div>
        <div id="correctVal" class="val">—</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnNext" class="btn big" style="flex:1">Следващ</button>
        <button id="btnReveal" class="btn big" style="flex:1">Покажи</button>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="card">
      <h3>Настройки</h3>

      <div class="row mini">Избери кои позиции да включваш в тренировката:</div>
      <div id="posFilters" class="row"></div>

      <div class="sep"></div>

      <div class="row mini">Избери стак диапазони:</div>
      <div id="stkFilters" class="row"></div>

      <div class="sep"></div>

      <div class="row">
        <button id="btnStart" class="btn big" style="flex:1">Старт / Рестарт</button>
        <button id="btnResetScore" class="btn" style="flex:1">Нулирай резултат</button>
      </div>

      <div class="sep"></div>

      <div class="mini">
        Формат на данните (същия като в инструмента):<br>
        <code>HAND = ACTION</code>, <code>default = ACTION</code>. За PUSH позиции – числа. Пример:<br>
        <pre>AJo = L-C-AI
default = Fold

(Пуш)
AJo = 45
default = 38</pre>
      </div>
    </div>
  </div>

  <!-- EDITOR -->
  <div id="editModal" class="overlay">
    <div class="box">
      <div class="boxHead">
        <div><b>Редактор на клетка</b> <span id="editMeta" class="mini"></span></div>
        <button id="editClose" class="btn">X</button>
      </div>
      <div class="boxBody">
        <div class="row">
          <select id="editPos" class="btn" style="flex:1"></select>
          <select id="editStk" class="btn" style="flex:1"></select>
        </div>
        <div class="row mini">Въведи редовете за тази позиция × стак:</div>
        <textarea id="editArea" placeholder="AJo = L-C-AI&#10;default = Fold"></textarea>
      </div>
      <div class="boxFoot">
        <button id="editClear" class="btn">Изчисти</button>
        <div>
          <button id="editSave" class="btn">Запази</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DATA IO -->
  <div id="dataModal" class="overlay">
    <div class="box">
      <div class="boxHead">
        <div><b>Import / Export</b> <span class="mini">(съдържа всички клетки)</span></div>
        <button id="dataClose" class="btn">X</button>
      </div>
      <div class="boxBody">
        <textarea id="dataArea" placeholder='{"HUSB||0–4":{"raw":"..."},"BBvsSB_L||13+":{"raw":"..."}}'></textarea>
      </div>
      <div class="boxFoot">
        <button id="dataImport" class="btn">Импорт</button>
        <button id="dataExport" class="btn">Експорт</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ====== Palette & helpers ======
  const COLORS={"FOLD":"#f4f6fa","L-F-F":"#a7e8a7","L-C-F":"#155d15","L-C-AI":"#bcdcf3","L-R-AI":"#0b3a94","MR-F-F":"#ffe27a","MR-C-AI":"#7b4a2a","MR-4B-AI":"#e44747","SHOVE":"#6d4b8e"};
  const norm=s=>(s||"").toUpperCase().replace(/\s+/g,"");
  const isPushPos=p=>/PUSH/i.test(p);
  const alias=(key,act)=>{const up=(act||"").toUpperCase(); if(!(key==="BBvsSB_L"||key==="HUBB_L"))return{d:act,c:null};
    if(up==="MR-F-F")return{d:"Check/Call",c:COLORS["MR-F-F"]};
    if(up==="L-C-AI")return{d:"ISO/Call",c:COLORS["L-C-AI"]};
    if(up==="SHOVE")return{d:"ISO/3bet AI",c:COLORS["SHOVE"]};
    if(up==="MR-4B-AI")return{d:"ISO/3bet/Fold",c:COLORS["MR-4B-AI"]};
    return{d:act,c:null};};
  const ACT_KEYS=["Fold","L-F-F","L-C-F","L-C-AI","L-R-AI","MR-F-F","MR-C-AI","MR-4B-AI","Shove"];

  // ====== Positions, stacks ======
  const GROUPS={
    HUSB:["HUSB","BU"],
    HUBB:["HUBB_L","HUBB_MR","HUBBv_PUSH"],
    SB:["SBvsBU","SBvsBU_PUSH","SBvsBB"],
    BB:["BBvsBU_MR","BBvsBU_PUSH","BBvsSB_L","BBvsSB_MR","BBvsSB_PUSH"]
  };
  const POS_LIST=[ "HUSB","BU","HUBB_L","HUBB_MR","HUBBv_PUSH","SBvsBU","SBvsBU_PUSH","SBvsBB","BBvsBU_MR","BBvsBU_PUSH","BBvsSB_L","BBvsSB_MR","BBvsSB_PUSH" ];
  const STKS=["0–4","4–7","7–10","10–13","13+"];

  // ====== Data store (compatible with your previous tool) ======
  let DB=JSON.parse(localStorage.getItem("qt_trainer_v1")||"{}");
  const k=(p,r)=>p+"||"+r; const get=(p,r)=>DB[k(p,r)]?.raw||""; const set=(p,r,raw)=>{DB[k(p,r)]={raw}; save();};
  const save=()=>localStorage.setItem("qt_trainer_v1", JSON.stringify(DB));

  function parseRaw(raw,push=false){ if(!raw)return{def:null,map:{}}; let def=null,map={};
    raw.split(/\r?\n|;/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
      const m=line.split("="); if(m.length===1){const v=m[0].trim(); if(!v)return; def=push?Number(v):v.toUpperCase();}
      else{const h=norm(m[0]); const v=m.slice(1).join("=").trim();
        if(/^DEFAULT$/i.test(h)) def=push?Number(v):v.toUpperCase();
        else if(h) map[h]=push?Number(v):v.toUpperCase(); }
    }); return{def,map}; }

  function compute(pos,hand,stk){
    const push=isPushPos(pos); const {def,map}=parseRaw(get(pos,stk),push); const key=norm(hand);
    if(push){const v = (map[key]!=null?map[key]:def); return {disp: v==null?"—":String(v), raw:v, isNum:true, color:null, act:v};}
    const act=(map[key]||def||"—"); const a=alias(pos,act);
    const col = COLORS[(a.d||"").toUpperCase()] || null;
    return {disp:a.d, raw:act, isNum:false, color: a.c || col};
  }

  // ====== Quiz state ======
  let curQ=null, count=0, right=0, streak=0, tStart=null, tTick=null;

  function formatHand(h){ // h = {r1,r2,type}
    const {r1,r2,type}=h;
    if(r1===r2) return r1+r2;
    return r1+r2+(type||"");
  }
  function rand(arr){return arr[Math.floor(Math.random()*arr.length)];}
  const RANKS=["A","K","Q","J","T","9","8","7","6","5","4","3","2"];

  function genRandom(filters){
    const pos = rand(filters.pos);
    const stk = rand(filters.stk);
    // генерираме ръка
    const r1 = rand(RANKS);
    const r2 = rand(RANKS);
    let type = null;
    if(r1!==r2) type = Math.random()<0.5 ? "s" : "o";
    const hand = formatHand({r1,r2,type:(r1===r2?null:type)});
    return {pos, stk, hand};
  }

  function refreshUI(){
    document.getElementById("qCount").textContent=count;
    document.getElementById("qRight").textContent=right;
    document.getElementById("streak").textContent=streak;
  }
  function startTimer(){
    tStart=Date.now();
    tTick && clearInterval(tTick);
    tTick=setInterval(()=>{
      const s=Math.floor((Date.now()-tStart)/1000);
      const m=Math.floor(s/60); const ss=String(s%60).padStart(2,"0");
      document.getElementById("timer").textContent=String(m).padStart(2,"0")+":"+ss;
    },500);
  }

  function bgFor(pos,label,val){
    if(/PUSH/i.test(pos)||/^\d+(\.\d+)?$/.test(val)) return getComputedStyle(document.documentElement).getPropertyValue('--push');
    if(/_MR$/.test(pos)||/\(MR\)/i.test(label)) return getComputedStyle(document.documentElement).getPropertyValue('--mr');
    if(/_L$/.test(pos)||/\(Limp\)/i.test(label)||pos==="BU"||pos==="HUSB") return getComputedStyle(document.documentElement).getPropertyValue('--limp');
    return "#0f1624";
  }

  // ====== Build filters UI ======
  function makeFilters(){
    const posC=document.getElementById("posFilters");
    posC.innerHTML="";
    POS_LIST.forEach(p=>{
      const lab=document.createElement("label"); lab.className="badge";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=true; cb.dataset.pos=p;
      lab.appendChild(cb); lab.append(" "+p);
      posC.appendChild(lab);
    });
    const stkC=document.getElementById("stkFilters");
    STKS.forEach(s=>{
      const lab=document.createElement("label"); lab.className="badge";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=true; cb.dataset.stk=s;
      lab.appendChild(cb); lab.append(" "+s);
      stkC.appendChild(lab);
    });
  }
  makeFilters();

  function getFilters(){
    const pos = Array.from(document.querySelectorAll('#posFilters input:checked')).map(x=>x.dataset.pos);
    const stk = Array.from(document.querySelectorAll('#stkFilters input:checked')).map(x=>x.dataset.stk);
    return {pos: pos.length?pos:POS_LIST, stk: stk.length?stk:STKS};
  }

  // ====== Quick action keys ======
  function buildQuickKeys(){
    const c=document.getElementById("quickKeys"); c.innerHTML="";
    ACT_KEYS.forEach(a=>{
      const b=document.createElement("button");
      b.className="btn"; b.textContent=a;
      b.onclick=()=>{ document.getElementById("answer").value=a; };
      c.appendChild(b);
    });
  }
  buildQuickKeys();

  // ====== Flow ======
  function askNew(){
    curQ = genRandom(getFilters());
    document.getElementById("qHand").textContent = curQ.hand;
    document.getElementById("qStack").textContent = "Стак: "+curQ.stk;
    document.getElementById("qPos").textContent = "Позиция: "+curQ.pos;
    document.getElementById("answer").value="";
    document.getElementById("feedback").textContent="";
    document.getElementById("correctRow").style.display="none";
    document.getElementById("answer").focus();
  }

  function checkAnswer(showOnly=false){
    if(!curQ) return;
    const {pos,hand,stk}=curQ;
    const res=compute(pos,hand,stk);
    const fb=document.getElementById("feedback");
    const cRow=document.getElementById("correctRow");
    const cVal=document.getElementById("correctVal");
    let ok=false;

    if(showOnly){
      fb.textContent="";
    }else{
      let ans=document.getElementById("answer").value.trim();
      if(isPushPos(pos)){ // числа
        ok = String(res.disp)!=="—" && ans!=="" && Number(ans)==Number(res.disp);
      }else{
        ok = res.disp!=="—" && norm(ans)===norm(res.disp);
      }
      count++; if(ok){ right++; streak++; fb.textContent="ВЯРНО!"; fb.className="feedback ok"; } else { streak=0; fb.textContent="ГРЕШНО"; fb.className="feedback err"; }
      refreshUI();
    }

    cRow.style.display="flex";
    cVal.textContent = res.disp;
    cRow.style.borderColor = ok ? "rgba(31,157,85,.6)" : "rgba(214,69,69,.6)";
    // цвет на стойността
    if(res.isNum){ cVal.style.background="rgba(0,0,0,.22)"; cVal.style.color="#fff"; }
    else{
      const ali=alias(pos,res.disp);
      const col = ali.c || COLORS[(res.disp||"").toUpperCase()] || "#2a2f3c";
      cVal.style.background = col; cVal.style.color = "#000";
    }
  }

  // ====== Editor ======
  const editModal=document.getElementById("editModal");
  const editPos=document.getElementById("editPos");
  const editStk=document.getElementById("editStk");
  const editArea=document.getElementById("editArea");
  function openEditor(){
    editPos.innerHTML = POS_LIST.map(p=>`<option value="${p}">${p}</option>`).join("");
    editStk.innerHTML = STKS.map(s=>`<option value="${s}">${s}</option>`).join("");
    const p=editPos.value, s=editStk.value;
    editArea.value=get(p,s)||"";
    document.getElementById("editMeta").textContent=`(${p} × ${s})`;
    editModal.classList.add("show");
  }
  editPos.addEventListener("change",()=>{editArea.value=get(editPos.value, editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} × ${editStk.value})`;});
  editStk.addEventListener("change",()=>{editArea.value=get(editPos.value, editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} × ${editStk.value})`;});
  document.getElementById("btnEdit").onclick=openEditor;
  document.getElementById("editClose").onclick=()=>editModal.classList.remove("show");
  document.getElementById("editSave").onclick=()=>{ set(editPos.value, editStk.value, editArea.value); editModal.classList.remove("show"); };
  document.getElementById("editClear").onclick=()=>{ if(confirm("Изчистване на тази клетка?")){ set(editPos.value, editStk.value, ""); editModal.classList.remove("show"); } };

  // ====== Data IO ======
  const dataModal=document.getElementById("dataModal");
  const dataArea=document.getElementById("dataArea");
  document.getElementById("btnData").onclick=()=>{ dataArea.value=JSON.stringify(DB,null,2); dataModal.classList.add("show"); };
  document.getElementById("dataClose").onclick=()=>dataModal.classList.remove("show");
  document.getElementById("dataExport").onclick=()=>{ dataArea.value=JSON.stringify(DB,null,2); dataArea.focus(); dataArea.select(); };
  document.getElementById("dataImport").onclick=()=>{ try{ const obj=JSON.parse(dataArea.value); DB=obj; save(); alert("Импорт успешно."); }catch(e){ alert("Невалиден JSON."); } };

  // ====== Buttons ======
  document.getElementById("btnStart").onclick=()=>{ count=right=streak=0; refreshUI(); startTimer(); askNew(); };
  document.getElementById("btnResetScore").onclick=()=>{ count=right=streak=0; refreshUI(); };
  document.getElementById("btnNext").onclick=askNew;
  document.getElementById("btnCheck").onclick=()=>checkAnswer(false);
  document.getElementById("btnReveal").onclick=()=>checkAnswer(true);

  // Enter = Проверка
  document.getElementById("answer").addEventListener("keydown",e=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById("btnCheck").click(); }});

  // Старт
  refreshUI();
})();
</script>
</body>
</html>
