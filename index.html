<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Range Trainer vT2</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1520; --panel2:#101827; --border:#223047; --text:#e7ecf3;
    --push:#6d4b8e; --mr:#c24a4a; --limp:#7fcf7f;
    --ok:#1f9d55; --err:#d64545;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Arial}

  /* –∫–æ–º–ø–∞–∫—Ç–Ω–∞ –≥–æ—Ä–Ω–∞ –ª–µ–Ω—Ç–∞ */
  .top{position:sticky;top:0;z-index:30;display:flex;gap:6px;align-items:center;justify-content:space-between;
       padding:6px 8px;background:#101827;border-bottom:1px solid var(--border)}
  .chips{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .chip{padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#0f1624;font-size:12px}
  .btn{border:1px solid var(--border);background:#0f1624;color:var(--text);border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.big{padding:12px 16px;font-size:18px}
  .btn.alt{background:#132035}

  .wrap{max-width:1100px;margin:0 auto;padding:10px}
  .grid{display:grid;gap:10px}
  @media (min-width:980px){.grid{grid-template-columns:1.1fr 0.9fr}}

  .card{border:1px solid var(--border);background:#0f1624;border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px;font-size:16px}

  /* quiz */
  .qTop{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .qHand{font-size:26px;font-weight:900}
  .qInfo{font-weight:800;opacity:.9}

  /* –æ—Ç–≥–æ–≤–æ—Ä ‚Äì –¥–≤–∞ —Ä–µ–∂–∏–º–∞ */
  .ansArea{margin-top:6px}
  .actionsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .actionsGrid .btn{padding:12px 8px;font-size:14px}

  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .key{border:1px solid var(--border);background:#111a2b;border-radius:12px;padding:16px 0;font-weight:900;font-size:20px}
  .key.wide{grid-column:span 2}
  .disp{margin:4px 0 8px;border:1px solid var(--border);background:#0b1220;border-radius:10px;padding:10px;font-weight:900;text-align:center}

  .feedback{margin-top:10px;font-weight:900}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .resRow{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px 10px;border:1px dashed #2a3b58;border-radius:10px;margin-top:8px}
  .val{font-weight:900;padding:6px 8px;border-radius:8px;min-width:96px;text-align:center}

  /* –∫–æ–Ω—Ç—Ä–æ–ª–∏ */
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#0f1624;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer}
  .badge input{accent-color:#4da3ff}
  .sep{height:1px;background:#223047;margin:10px 0}

  /* –º–æ–¥–∞–ª–∏ */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:60;align-items:center;justify-content:center;padding:16px}
  .overlay.show{display:flex}
  .box{width:100%;max-width:680px;background:#0f1520;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .boxHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#101827;border-bottom:1px solid var(--border)}
  .boxBody{padding:10px 12px}
  .boxFoot{display:flex;gap:8px;justify-content:space-between;padding:10px 12px;border-top:1px solid var(--border);background:#0f1520}
  textarea{width:100%;min-height:260px;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;font:14px/1.35 ui-monospace,Menlo,Consolas}
  .mini{font-size:12px;opacity:.8}
</style>
</head>
<body>
  <div class="top">
    <div class="chips">
      <span class="chip">Q: <b id="qCount">0</b></span>
      <span class="chip">‚úî: <b id="qRight">0</b></span>
      <span class="chip">üî•: <b id="streak">0</b></span>
      <span class="chip">‚è± <b id="timer">00:00</b></span>
    </div>
    <div style="display:flex;gap:6px">
      <button class="btn" id="btnEdit">–†–µ–¥–∞–∫—Ç–æ—Ä</button>
      <button class="btn alt" id="btnData">Import/Export</button>
    </div>
  </div>

  <div class="wrap grid">
    <!-- QUIZ -->
    <div class="card">
      <h3>–¢—Ä–µ–Ω–∞–∂–æ—Ä</h3>

      <div class="qTop">
        <div class="qHand" id="qHand">‚Äî</div>
        <div class="qInfo" id="qStack">–°—Ç–∞–∫: ‚Äî</div>
        <div class="qInfo" id="qPos">–ü–æ–∑–∏—Ü–∏—è: ‚Äî</div>
      </div>

      <div id="ansArea" class="ansArea"></div>

      <div id="feedback" class="feedback"></div>
      <div id="correctRow" class="resRow" style="display:none">
        <div>–ü—Ä–∞–≤–∏–ª–µ–Ω:</div>
        <div id="correctVal" class="val">‚Äî</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnNext" class="btn big" style="flex:1">–°–ª–µ–¥–≤–∞—â</button>
        <button id="btnReveal" class="btn big" style="flex:1">–ü–æ–∫–∞–∂–∏</button>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="card">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

      <div class="mini">–ü–æ–∑–∏—Ü–∏–∏ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ç–∞:</div>
      <div id="posFilters" class="row"></div>

      <div class="sep"></div>

      <div class="mini">–°—Ç–∞–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–∏:</div>
      <div id="stkFilters" class="row"></div>

      <div class="sep"></div>

      <div class="row">
        <button id="btnStart" class="btn big" style="flex:1">–°—Ç–∞—Ä—Ç / –†–µ—Å—Ç–∞—Ä—Ç</button>
        <button id="btnResetScore" class="btn" style="flex:1">–ù—É–ª–∏—Ä–∞–π</button>
      </div>
    </div>
  </div>

  <!-- EDITOR -->
  <div id="editModal" class="overlay">
    <div class="box">
      <div class="boxHead">
        <div><b>–†–µ–¥–∞–∫—Ç–æ—Ä</b> <span id="editMeta" class="mini"></span></div>
        <button id="editClose" class="btn">X</button>
      </div>
      <div class="boxBody">
        <div class="row">
          <select id="editPos" class="btn" style="flex:1"></select>
          <select id="editStk" class="btn" style="flex:1"></select>
        </div>
        <div class="row mini">–§–æ—Ä–º–∞—Ç: <code>HAND = ACTION</code> / <code>default = ACTION</code>; –∑–∞ PUSH ‚Äî —Ü–∏—Ñ—Ä–∏.</div>
        <textarea id="editArea" placeholder="AJo = L-C-AI&#10;default = Fold"></textarea>
      </div>
      <div class="boxFoot">
        <button id="editClear" class="btn">–ò–∑—á–∏—Å—Ç–∏</button>
        <div>
          <button id="editSave" class="btn">–ó–∞–ø–∞–∑–∏</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DATA IO -->
  <div id="dataModal" class="overlay">
    <div class="box">
      <div class="boxHead">
        <div><b>Import / Export</b> <span class="mini">(JSON, —Å—ä–≤–º–µ—Å—Ç–∏–º —Å –ø—Ä–µ–¥–∏—à–Ω–∏—Ç–µ –≤–µ—Ä—Å–∏–∏)</span></div>
        <button id="dataClose" class="btn">X</button>
      </div>
      <div class="boxBody">
        <textarea id="dataArea" placeholder='{"HUSB||0‚Äì4":{"raw":"..."},"BBvsSB_L||13+":{"raw":"..."}}'></textarea>
      </div>
      <div class="boxFoot">
        <button id="dataImport" class="btn">–ò–º–ø–æ—Ä—Ç</button>
        <button id="dataExport" class="btn">–ï–∫—Å–ø–æ—Ä—Ç</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Palette & helpers =====
  const COLORS={"FOLD":"#f4f6fa","L-F-F":"#a7e8a7","L-C-F":"#155d15","L-C-AI":"#bcdcf3","L-R-AI":"#0b3a94","MR-F-F":"#ffe27a","MR-C-AI":"#7b4a2a","MR-4B-AI":"#e44747","SHOVE":"#6d4b8e"};
  const norm=s=>(s||"").toUpperCase().replace(/\s+/g,"");
  const isPushPos=p=>/PUSH/i.test(p);
  const alias=(key,act)=>{const up=(act||"").toUpperCase(); if(!(key==="BBvsSB_L"||key==="HUBB_L"))return{d:act,c:null};
    if(up==="MR-F-F")return{d:"Check/Call",c:COLORS["MR-F-F"]};
    if(up==="L-C-AI")return{d:"ISO/Call",c:COLORS["L-C-AI"]};
    if(up==="SHOVE")return{d:"ISO/3bet AI",c:COLORS["SHOVE"]};
    if(up==="MR-4B-AI")return{d:"ISO/3bet/Fold",c:COLORS["MR-4B-AI"]};
    return{d:act,c:null};};

  const ACTIONS=["Fold","L-F-F","L-C-F","L-C-AI","L-R-AI","MR-F-F","MR-C-AI","MR-4B-AI","Shove"];

  // ===== Positions / stacks =====
  const POS_LIST=[ "HUSB","BU","HUBB_L","HUBB_MR","HUBBv_PUSH","SBvsBU","SBvsBU_PUSH","SBvsBB","BBvsBU_MR","BBvsBU_PUSH","BBvsSB_L","BBvsSB_MR","BBvsSB_PUSH" ];
  const STKS=["0‚Äì4","4‚Äì7","7‚Äì10","10‚Äì13","13+"];

  // ===== DB storage (compatible) =====
  let DB=JSON.parse(localStorage.getItem("qt_trainer_v2")||"{}");
  const save=()=>localStorage.setItem("qt_trainer_v2",JSON.stringify(DB));
  const k=(p,r)=>p+"||"+r;
  const get=(p,r)=>DB[k(p,r)]?.raw||"";
  const set=(p,r,raw)=>{DB[k(p,r)]={raw};save();};

  function parseRaw(raw,push=false){ if(!raw)return{def:null,map:{}}; let def=null,map={};
    raw.split(/\r?\n|;/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
      const m=line.split("="); if(m.length===1){const v=m[0].trim(); if(!v)return; def=push?Number(v):v.toUpperCase();}
      else{const h=norm(m[0]); const v=m.slice(1).join("=").trim();
        if(/^DEFAULT$/i.test(h)) def=push?Number(v):v.toUpperCase();
        else if(h) map[h]=push?Number(v):v.toUpperCase(); }
    }); return{def,map}; }

  function compute(pos,hand,stk){
    const push=isPushPos(pos); const {def,map}=parseRaw(get(pos,stk),push); const key=norm(hand);
    if(push){const v=map[key]!=null?map[key]:def; return {disp: v==null?"‚Äî":String(v), raw:v, isNum:true, color:null, act:v};}
    const act=(map[key]||def||"‚Äî"); const a=alias(pos,act);
    const col = COLORS[(a.d||"").toUpperCase()] || null;
    return {disp:a.d, raw:act, isNum:false, color: a.c || col};
  }

  // ===== Quiz state =====
  let curQ=null, count=0, right=0, streak=0, tStart=null, tTick=null;

  function refreshTop(){
    document.getElementById("qCount").textContent=count;
    document.getElementById("qRight").textContent=right;
    document.getElementById("streak").textContent=streak;
  }
  function startTimer(){
    tStart=Date.now();
    tTick && clearInterval(tTick);
    tTick=setInterval(()=>{
      const s=Math.floor((Date.now()-tStart)/1000);
      const m=Math.floor(s/60); const ss=String(s%60).padStart(2,"0");
      document.getElementById("timer").textContent=String(m).padStart(2,"0")+":"+ss;
    },500);
  }

  const RANKS=["A","K","Q","J","T","9","8","7","6","5","4","3","2"];
  const rand=arr=>arr[Math.floor(Math.random()*arr.length)];
  const handStr=(r1,r2)=> r1===r2 ? r1+r2 : r1+r2+(Math.random()<0.5?"s":"o");

  function getFilters(){
    const pos = Array.from(document.querySelectorAll('#posFilters input:checked')).map(x=>x.dataset.pos);
    const stk = Array.from(document.querySelectorAll('#stkFilters input:checked')).map(x=>x.dataset.stk);
    return {pos: pos.length?pos:POS_LIST, stk: stk.length?stk:STKS};
  }

  function buildFilters(){
    const posC=document.getElementById("posFilters"); posC.innerHTML="";
    POS_LIST.forEach(p=>{
      const lab=document.createElement("label"); lab.className="badge";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=true; cb.dataset.pos=p;
      lab.appendChild(cb); lab.append(" "+p); posC.appendChild(lab);
    });
    const stkC=document.getElementById("stkFilters"); stkC.innerHTML="";
    STKS.forEach(s=>{
      const lab=document.createElement("label"); lab.className="badge";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=true; cb.dataset.stk=s;
      lab.appendChild(cb); lab.append(" "+s); stkC.appendChild(lab);
    });
  }
  buildFilters();

  function askNew(){
    const f=getFilters();
    const pos=rand(f.pos);
    const stk=rand(f.stk);
    const r1=rand(RANKS), r2=rand(RANKS);
    const hand=handStr(r1,r2);
    curQ={pos,stk,hand};
    document.getElementById("qHand").textContent=hand;
    document.getElementById("qStack").textContent="–°—Ç–∞–∫: "+stk;
    document.getElementById("qPos").textContent="–ü–æ–∑–∏—Ü–∏—è: "+pos;
    document.getElementById("feedback").textContent="";
    document.getElementById("correctRow").style.display="none";
    renderAnswerUI();
  }

  // ===== Answer UI (buttons only) =====
  let numBuf=""; // –∑–∞ push
  function clearAnsUI(){ const a=document.getElementById("ansArea"); a.innerHTML=""; }

  function renderAnswerUI(){
    clearAnsUI();
    const a=document.getElementById("ansArea");
    if(isPushPos(curQ.pos)){
      // keypad
      numBuf="";
      const disp=document.createElement("div"); disp.className="disp"; disp.id="numDisp"; disp.textContent="–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ";
      const grid=document.createElement("div"); grid.className="keypad";
      const keys=["7","8","9","4","5","6","1","2","3",".","0","‚Üê"];
      keys.forEach(k=>{
        const b=document.createElement("button"); b.className="key"; b.textContent=k;
        b.onclick=()=>keyPress(k);
        grid.appendChild(b);
      });
      const clr=document.createElement("button"); clr.className="key wide"; clr.textContent="Clear";
      clr.onclick=()=>{numBuf=""; updateDisp();};
      const ok=document.createElement("button"); ok.className="key wide"; ok.textContent="–ü—Ä–æ–≤–µ—Ä–∏";
      ok.onclick=()=>checkAnswer(false);
      a.appendChild(disp); a.appendChild(grid); a.appendChild(clr); a.appendChild(ok);
    }else{
      // actions grid
      const g=document.createElement("div"); g.className="actionsGrid";
      ACTIONS.forEach(act=>{
        const b=document.createElement("button"); b.className="btn"; b.textContent=act;
        b.onclick=()=>submitAction(act);
        g.appendChild(b);
      });
      a.appendChild(g);
    }
  }

  function updateDisp(){
    document.getElementById("numDisp").textContent = numBuf.length? numBuf : "–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ";
  }
  function keyPress(k){
    if(k==="‚Üê"){ numBuf=numBuf.slice(0,-1); updateDisp(); return; }
    // —Å–∞–º–æ –µ–¥–∏–Ω –¥–µ—Å–µ—Ç–∏—á–µ–Ω —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª
    if(k==="." && numBuf.includes(".")) return;
    // –º–∞–∫—Å–∏–º—É–º 5-6 —Å–∏–º–≤–æ–ª–∞ –∑–∞ –±—ä—Ä–∑–∏–Ω–∞
    if(numBuf.length>=6) return;
    numBuf += k;
    updateDisp();
  }

  function submitAction(act){
    // –¥–∏—Ä–µ–∫—Ç–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ (–º–∏–Ω–∏–º—É–º –∫–ª–∏–∫–æ–≤–µ)
    checkAnswer(false, act);
  }

  function checkAnswer(showOnly=false, chosenAct=null){
    if(!curQ) return;
    const {pos,hand,stk}=curQ;
    const res=compute(pos,hand,stk);
    const fb=document.getElementById("feedback");
    const cRow=document.getElementById("correctRow");
    const cVal=document.getElementById("correctVal");

    // –∞–∫–æ –Ω—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ —Ç–∞–∑–∏ –∫–ª–µ—Ç–∫–∞ ‚Äì –Ω–µ –±—Ä–æ–∏–º –≤—ä–ø—Ä–æ—Å
    if(res.disp==="‚Äî"){
      fb.textContent="–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ —Ç–∞–∑–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è."; fb.className="feedback";
      cRow.style.display="flex"; cVal.textContent="‚Äî"; cVal.style.background="#2a2f3c"; cVal.style.color="#fff";
      return;
    }

    let ok=false;
    if(showOnly){
      fb.textContent="";
    }else{
      if(isPushPos(pos)){
        const ans = Number(numBuf);
        const tgt = Number(res.disp);
        if(!Number.isFinite(ans)){ fb.textContent="–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ."; fb.className="feedback"; return; }
        ok = Math.abs(ans - tgt) <= 0.1; // —Ç–æ–ª–µ—Ä–∞–Ω—Å 0.1
      }else{
        ok = norm(chosenAct||"") === norm(res.disp);
      }
      count++; if(ok){ right++; streak++; fb.textContent="–í–Ø–†–ù–û!"; fb.className="feedback ok"; } else { streak=0; fb.textContent="–ì–†–ï–®–ù–û"; fb.className="feedback err"; }
      refreshTop();
    }

    cRow.style.display="flex";
    cVal.textContent = res.disp;
    if(res.isNum){ cVal.style.background="rgba(0,0,0,.22)"; cVal.style.color="#fff"; }
    else{
      const ali=alias(pos,res.disp);
      const col = ali.c || COLORS[(res.disp||"").toUpperCase()] || "#2a2f3c";
      cVal.style.background = col; cVal.style.color = "#000";
    }
  }

  // ===== Editor & Data IO =====
  const editModal=document.getElementById("editModal");
  const editPos=document.getElementById("editPos");
  const editStk=document.getElementById("editStk");
  const editArea=document.getElementById("editArea");
  function openEditor(){
    editPos.innerHTML = POS_LIST.map(p=>`<option value="${p}">${p}</option>`).join("");
    editStk.innerHTML = STKS.map(s=>`<option value="${s}">${s}</option>`).join("");
    const p=editPos.value, s=editStk.value;
    editArea.value=get(p,s)||"";
    document.getElementById("editMeta").textContent=`(${p} √ó ${s})`;
    editModal.classList.add("show");
  }
  editPos.addEventListener("change",()=>{editArea.value=get(editPos.value, editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} √ó ${editStk.value})`;});
  editStk.addEventListener("change",()=>{editArea.value=get(editPos.value, editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} √ó ${editStk.value})`;});
  document.getElementById("btnEdit").onclick=openEditor;
  document.getElementById("editClose").onclick=()=>editModal.classList.remove("show");
  document.getElementById("editSave").onclick=()=>{ set(editPos.value, editStk.value, editArea.value); editModal.classList.remove("show"); };
  document.getElementById("editClear").onclick=()=>{ if(confirm("–ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç–∞–∑–∏ –∫–ª–µ—Ç–∫–∞?")){ set(editPos.value, editStk.value, ""); editModal.classList.remove("show"); } };

  const dataModal=document.getElementById("dataModal");
  const dataArea=document.getElementById("dataArea");
  document.getElementById("btnData").onclick=()=>{ dataArea.value=JSON.stringify(DB,null,2); dataModal.classList.add("show"); };
  document.getElementById("dataClose").onclick=()=>dataModal.classList.remove("show");
  document.getElementById("dataExport").onclick=()=>{ dataArea.value=JSON.stringify(DB,null,2); dataArea.focus(); dataArea.select(); };
  document.getElementById("dataImport").onclick=()=>{ try{ const obj=JSON.parse(dataArea.value); DB=obj; save(); alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ."); }catch(e){ alert("–ù–µ–≤–∞–ª–∏–¥–µ–Ω JSON."); } };

  // ===== Controls =====
  document.getElementById("btnStart").onclick=()=>{ count=right=streak=0; refreshTop(); startTimer(); askNew(); };
  document.getElementById("btnResetScore").onclick=()=>{ count=right=streak=0; refreshTop(); };

  document.getElementById("btnNext").onclick=askNew;
  document.getElementById("btnReveal").onclick=()=>checkAnswer(true);

  // –°—Ç–∞—Ä—Ç–æ–≤–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ
  refreshTop();
})();
</script>
</body>
</html>
